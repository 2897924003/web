import{Q as j}from"./QSelect-aA8iUZEr.js";import{Q as A}from"./QInput-C0kg-8gv.js";import{l as z,r as p,p as R,m as M,n as U,o as w,h as D,q as O,g as T,v as H,t as B,x as K,y as N,_ as G,z as k,A as L,u as P,B as J,C as W,D as h,Q as X,E,j as r,G as F,H as S,I as Y,J as Z,K as $}from"./index-CeeqmRIO.js";import{Q as ee}from"./QCheckbox-DYH2lDU-.js";import{a as te,Q as ae}from"./QPage-BHVqYzDk.js";import{api as I}from"./axios-BXZ1rSmn.js";import"./QDialog-ClFP_LGy.js";const oe=z({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(c,{slots:l,emit:s}){const o=T(),i=p(null);let u=0;const e=[];function v(t){const a=typeof t=="boolean"?t:c.noErrorFocus!==!0,_=++u,Q=(n,d)=>{s(`validation${n===!0?"Success":"Error"}`,d)},V=n=>{const d=n.validate();return typeof d.then=="function"?d.then(m=>({valid:m,comp:n}),m=>({valid:!1,comp:n,err:m})):Promise.resolve({valid:d,comp:n})};return(c.greedy===!0?Promise.all(e.map(V)).then(n=>n.filter(d=>d.valid!==!0)):e.reduce((n,d)=>n.then(()=>V(d).then(m=>{if(m.valid===!1)return Promise.reject(m)})),Promise.resolve()).catch(n=>[n])).then(n=>{if(n===void 0||n.length===0)return _===u&&Q(!0),!0;if(_===u){const{comp:d,err:m}=n[0];if(m!==void 0&&console.error(m),Q(!1,d),a===!0){const C=n.find(({comp:q})=>typeof q.focus=="function"&&H(q.$)===!1);C!==void 0&&C.comp.focus()}}return!1})}function f(){u++,e.forEach(t=>{typeof t.resetValidation=="function"&&t.resetValidation()})}function y(t){t!==void 0&&B(t);const a=u+1;v().then(_=>{a===u&&_===!0&&(c.onSubmit!==void 0?s("submit",t):t!==void 0&&t.target!==void 0&&typeof t.target.submit=="function"&&t.target.submit())})}function b(t){t!==void 0&&B(t),s("reset"),K(()=>{f(),c.autofocus===!0&&c.noResetFocus!==!0&&g()})}function g(){te(()=>{if(i.value===null)return;const t=i.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||i.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||i.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(i.value.querySelectorAll("[tabindex]"),a=>a.tabIndex!==-1);t?.focus({preventScroll:!0})})}R(N,{bindComponent(t){e.push(t)},unbindComponent(t){const a=e.indexOf(t);a!==-1&&e.splice(a,1)}});let x=!1;return M(()=>{x=!0}),U(()=>{x===!0&&c.autofocus===!0&&g()}),w(()=>{c.autofocus===!0&&g()}),Object.assign(o.proxy,{validate:v,resetValidation:f,submit:y,reset:b,focus:g,getValidationComponents:()=>e}),()=>D("form",{class:"q-form",ref:i,onSubmit:y,onReset:b},O(l.default))}}),ne={__name:"LoginLayout",setup(c,{expose:l}){l();const s=k(),o=p(null),i=p(null),u=L(),e=P(),v=p(!1),f=p({label:null,path:null}),y=p([{label:"学生管理系统",path:"systemA"},{label:"项目管理系统",path:"systemB"},{label:"测试系统",path:"authentication"},{label:"聊天室",path:"chat"}]),b=async()=>{await u.push("mainlayout")},g=async()=>{if(s.loadingBar.start(),s.loadingBar.stop(),!f.value.path){s.notify({message:"请选择一个系统",position:"top",color:"red",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"});return}const a=await I.post("/login",{username:o.value,password:i.value,"remember-me":v.value?"on":"off"},{headers:{"Content-Type":"application/x-www-form-urlencoded"},withCredentials:!0});a.data.status===200?(sessionStorage.setItem("jwt",a.headers.get("Authorization")),alert(a.headers.get("Authorization")),s.notify({message:"欢迎!",position:"top",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"}),e.login(),await u.push("/mainlayout")):s.notify({message:a.data.message,position:"top",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"})},x=async()=>{if(!f.value.label){s.notify({message:"请选择一个系统",position:"top",color:"red",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"});return}(await E.post(`https://test.opensun.asia/api/${f.value.value}/client-register`,{username:o.value,password:i.value},{headers:{"Content-Type":"application/json"}})).data.code===1?(s.notify({message:"注册成功!",position:"top",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"}),e.login(),await u.push("/mainlayout")):s.notify({message:"账号已存在",position:"top",avatar:"https://cdn.quasar.dev/img/boy-avatar.png"})};w(async()=>{const a=document.createElement("script");a.src="https://recaptcha.net/recaptcha/api.js",a.async=!0,a.defer=!0,document.body.appendChild(a)});const t={$q:s,username:o,password:i,$router:u,authStore:e,rememberMe:v,selectedSystem:f,systems:y,anonymous:b,formLogin:g,register:x,onMounted:w,ref:p,get useQuasar(){return k},get useRouter(){return L},get useAuthStore(){return P},get api(){return I},get axios(){return E}};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}},se={class:"q-pa-md",style:{"max-width":"400px"}},re={class:"row justify-around"};function le(c,l,s,o,i,u){return J(),W(X,{view:"lHh Lpr lFf"},{default:h(()=>[r($,null,{default:h(()=>[r(ae,{class:"login-page-background flex flex-center",style:{"max-width":"100%","max-height":"100%"}},{default:h(()=>[F("div",se,[r(oe,{onSubmit:o.formLogin,class:"q-gutter-md"},{default:h(()=>[r(j,{modelValue:o.selectedSystem,"onUpdate:modelValue":l[0]||(l[0]=e=>o.selectedSystem=e),options:o.systems,label:"选择系统",outlined:"",dense:"",clearable:"",color:"black","bg-color":"teal"},null,8,["modelValue","options"]),r(A,{clearable:"","bg-color":"teal",rounded:"",outlined:"",modelValue:o.username,"onUpdate:modelValue":l[1]||(l[1]=e=>o.username=e),label:"账号","lazy-rules":"",rules:[e=>e&&e.length>0||"不能为空"]},null,8,["modelValue","rules"]),r(A,{clearable:"","bg-color":"teal",rounded:"",outlined:"",modelValue:o.password,"onUpdate:modelValue":l[2]||(l[2]=e=>o.password=e),label:"密码","lazy-rules":"",rules:[e=>e!==null&&e!==""||"不能为空",e=>e.length>0&&e.length<50||"密码过长"]},null,8,["modelValue","rules"]),F("div",re,[r(S,{push:"",label:"登录",type:"login",color:"teal","text-color":"black"}),r(S,{push:"",label:"注册",onClick:o.register,color:"teal"}),r(S,{push:"",label:"匿名访问",onClick:o.anonymous,color:"teal"}),r(S,{push:"",href:"https://test.opensun.asia/oauth2/authorization/github",color:"teal"},{default:h(()=>[r(Y,null,{default:h(()=>[r(Z,{name:"fa-brands fa-github"})]),_:1})]),_:1}),r(ee,{label:"记住密码","checked-icon":"star","unchecked-icon":"star_border",modelValue:o.rememberMe,"onUpdate:modelValue":l[3]||(l[3]=e=>o.rememberMe=e)},null,8,["modelValue"])])]),_:1})])]),_:1})]),_:1})]),_:1})}const he=G(ne,[["render",le],["__scopeId","data-v-51151e26"],["__file","LoginLayout.vue"]]);export{he as default};
